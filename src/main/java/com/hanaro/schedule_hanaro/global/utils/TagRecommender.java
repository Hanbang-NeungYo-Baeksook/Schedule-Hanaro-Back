package com.hanaro.schedule_hanaro.global.utils;

import java.util.*;
import java.util.stream.Collectors;

public class TagRecommender {
    // 사전 정의된 태그 목록
    private static final List<String> PREDEFINED_TAGS = Arrays.asList(
            "인증", "확인", "인증서", "계좌", "통장", "변경", "뱅킹", "금융", "대출", "한도",
            "신청", "등록", "조회", "결과", "예금", "적금", "고객", "개인", "회원", "비밀번호",
            "보안", "소득", "증명서", "증빙", "서류", "자료", "거래", "입금", "금리", "계약",
            "약정", "투자", "자금", "문의", "상담", "우대", "포인트", "지점", "전화", "모바일",
            "기간", "조건", "업무", "조치", "제출", "화면", "입력", "상태", "서비스", "비대면", "미성년자"
    );

    // 태그별 관련 키워드 매핑
    private static final Map<String, List<String>> TAG_KEYWORDS = new HashMap<>() {{
        put("인증", Arrays.asList(
            "본인", "발급", "공동", "금융", "생체", "지문", "안면", "간편", "PIN", 
            "패스워드", "SMS", "카카오", "네이버", "토큰", "QR", "보안카드", "신분증"
        ));

        put("계좌", Arrays.asList(
            "통장", "잔액", "이체", "송금", "예금주", "자동이체", "수수료", "개설", 
            "전환", "내역", "잔고", "연동", "주거래", "급여", "마이너스", "종합", 
            "외화", "CMA", "MMF"
        ));

        put("대출", Arrays.asList(
            "한도", "금리", "상환", "이자", "대부", "담보", "신용", "원금", "만기",
            "중도", "심사", "전세", "분할", "원리금", "연체", "스케줄", "기간", "조건"
        ));

        put("신청", Arrays.asList(
            "접수", "발급", "개설", "가입", "신규", "발행", "해지", "취소", "절차",
            "상태", "재신청", "자격", "양식", "승인", "반려", "보완", "비대면"
        ));

        put("조회", Arrays.asList(
            "내역", "거래", "잔액", "한도", "결과", "상태", "현황", "기록", "기간",
            "상세", "실시간", "승인", "미승인", "보유", "이용", "납부", "청구"
        ));

        put("보안", Arrays.asList(
            "암호", "보호", "해킹", "피싱", "OTP", "채널", "이상거래", "등급", "설정",
            "프로그램", "백신", "생체", "지문", "안면", "패턴", "디바이스"
        ));

        put("서류", Arrays.asList(
            "증명서", "증빙", "신분증", "등본", "초본", "재직", "소득", "계약서",
            "원천징수", "급여명세", "근로", "임대차", "등기부", "납세", "건강보험"
        ));

        put("금융", Arrays.asList(
            "은행", "예금", "적금", "펀드", "투자", "주식", "채권", "환전", "외환",
            "수수료", "상품", "증권", "보험", "카드", "외화", "원화", "자산", "시장"
        ));

        put("고객", Arrays.asList(
            "회원", "가입자", "개인", "법인", "사업자", "미성년자", "외국인", "상속인",
            "대리인", "센터", "상담", "지원", "정보", "등급", "혜택", "특전", "우대", "멤버십"
        ));

        put("비대면", Arrays.asList(
            "온라인", "모바일", "앱", "인터넷", "웹", "전자", "디지털", "스마트",
            "원격", "화상", "전자서명", "채널", "비접촉", "언택트"
        ));

        put("상담", Arrays.asList(
            "문의", "안내", "설명", "답변", "응대", "질문", "요청", "불만", "민원",
            "고충", "센터", "콜센터", "상담원", "예약", "이력", "피드백"
        ));

        put("변경", Arrays.asList(
            "수정", "갱신", "재발급", "해지", "취소", "정정", "변동", "업데이트",
            "이력", "사유", "절차", "방법"
        ));

        put("뱅킹", Arrays.asList(
            "인터넷", "모바일", "스마트", "폰", "전자금융", "온라인", "디지털", "앱",
            "오픈", "간편", "자동화기기", "ATM", "CD기", "공인인증서"
        ));

        put("거래", Arrays.asList(
            "이체", "결제", "송금", "입금", "출금", "환전", "납부", "청구", "정산",
            "매매", "한도", "제한", "정지", "수수료", "승인", "취소", "실패"
        ));

        put("우대", Arrays.asList(
            "혜택", "할인", "캐시백", "포인트", "마일리지", "리워드", "이벤트",
            "프로모션", "특전", "금리", "수수료", "조건", "기간", "한도", "등급", "VIP"
        ));

        put("지점", Arrays.asList(
            "영업점", "점포", "창구", "ATM", "CD기", "센터", "지사", "출장소",
            "본점", "영업시간", "방문", "내방", "대기", "번호표", "담당자"
        ));

        put("서비스", Arrays.asList(
            "기능", "업무", "절차", "진행", "방법", "과정", "단계", "시간", "담당",
            "처리", "지침", "안내", "완료", "요청", "지연", "오류", "시스템"
        ));

        put("예금", Arrays.asList(
            "적금", "정기", "보통", "저축", "이자", "만기", "해지", "연장", "예치",
            "종류", "상품", "이율", "특판", "자유", "청년", "주택청약", "재형"
        ));

        put("투자", Arrays.asList(
            "펀드", "주식", "채권", "ELS", "CMA", "ISA", "연금", "수익률", "위험도",
            "원금", "설명서", "성향", "전략", "실적", "손실", "분산", "환매", "매수", "매도"
        ));

        put("약정", Arrays.asList(
            "계약", "동의", "약관", "규정", "조건", "기간", "한도", "제한", "의무",
            "만료", "재약정", "연장", "특약", "부대", "위반", "준수", "체결"
        ));

        put("미성년자", Arrays.asList(
            "청소년", "어린이", "주니어", "영유아", "학생", "아동", "법정대리인",
            "친권자", "후견인", "보호자", "동의", "교육", "수당", "학자금"
        ));

        put("자금", Arrays.asList(
            "현금", "자본", "여유", "운영", "대출", "투자", "결제", "정산", "보증금",
            "예치금", "적립금", "조달", "운용", "세탁", "흐름", "계획", "지원"
        ));

        put("업무", Arrays.asList(
            "처리", "절차", "진행", "방법", "과정", "단계", "시간", "담당", "접수",
            "지침", "안내", "완료", "요청", "지연", "오류", "협조", "제한"
        ));

        put("확인", Arrays.asList(
            "검증", "점검", "체크", "검사", "승인", "확정", "인가", "증명", "실명",
            "진위", "사실", "처리", "접수", "완료", "오류", "내역", "예약"
        ));

        put("인증서", Arrays.asList(
            "공동", "금융", "전자", "공인", "간편", "발급", "갱신", "폐기", "만료",
            "복사", "백업", "이동", "암호", "관리", "유효기간", "검증"
        ));

        put("통장", Arrays.asList(
            "계좌", "내역", "잔액", "입출금", "정리", "발급", "재발급", "분실", "정지",
            "해지", "개설", "사본", "기장", "이체", "잔고", "전환", "종류"
        ));

        put("한도", Arrays.asList(
            "금액", "조정", "증액", "감액", "이체", "출금", "신용", "카드", "초과",
            "설정", "상향", "하향", "승인", "일일", "월", "최대", "기본", "잔여"
        ));

        put("등록", Arrays.asList(
            "신규", "정보", "카드", "지문", "생체", "자동이체", "기기", "신청",
            "완료", "취소", "방법", "절차", "현황", "내역", "상태", "갱신", "해지"
        ));

        put("결과", Arrays.asList(
            "처리", "신청", "심사", "검토", "이체", "거래", "통지", "안내", "내역",
            "통보", "회신", "보고", "분석", "최종", "중간", "완료", "성공", "실패"
        ));

        put("적금", Arrays.asList(
            "정기", "자유", "청년", "주택청약", "급여", "스마트", "목돈", "저축",
            "이율", "이자", "만기", "해지", "가입", "기간", "납입", "금리", "혜택"
        ));

        put("개인", Arrays.asList(
            "고객", "사업자", "정보", "신분증", "실명", "본인", "주민번호", "신용",
            "대출", "자산", "계좌", "카드", "회원", "식별", "맞춤", "상담"
        ));

        put("회원", Arrays.asList(
            "가입", "정보", "등록", "탈퇴", "자격", "혜택", "등급", "카드", "약관",
            "특전", "우대", "관리", "식별", "신규", "기존", "휴면"
        ));

        put("비밀번호", Arrays.asList(
            "패스워드", "PIN", "암호", "보안번호", "인증번호", "재설정", "초기화",
            "규칙", "만료", "갱신", "임시", "로그인", "거래", "계좌", "카드"
        ));

        put("소득", Arrays.asList(
            "수입", "급여", "연봉", "증빙", "공제", "신고", "증명", "수준", "분위",
            "기준", "근로", "사업", "금융", "임대", "연간", "월평균", "가계"
        ));

        put("증명서", Arrays.asList(
            "확인서", "증빙", "발급", "재발급", "신청", "조회", "출력", "제출",
            "진위", "원본", "사본", "양식", "발행", "유효기간", "위조", "전자"
        ));

        put("증빙", Arrays.asList(
            "서류", "자료", "제출", "요청", "검토", "심사", "완료", "보완", "반려",
            "승인", "사진", "스캔", "등록", "조회", "관리", "보관", "요건"
        ));

        put("자료", Arrays.asList(
            "데이터", "정보", "문서", "서류", "파일", "제출", "검토", "등록", "수정",
            "관리", "보관", "열람", "공유", "전송", "첨부", "백업", "복구"
        ));

        put("입금", Arrays.asList(
            "송금", "이체", "납부", "충전", "계좌", "내역", "처리", "완료", "오류",
            "지연", "한도", "증", "알림", "예정", "취소", "수수료", "제한"
        ));

        put("금리", Arrays.asList(
            "이자율", "이자", "우대", "인하", "조정", "적용", "계산", "비교", "혜택",
            "조회", "인상", "변동", "고정", "타입", "약정", "대출", "예금", "적금"
        ));

        put("계약", Arrays.asList(
            "약정", "조건", "기간", "해지", "변경", "갱신", "만료", "체결", "연장",
            "종료", "내용", "위반", "해제", "취소", "이행", "당사자", "특약"
        ));

        put("문의", Arrays.asList(
            "질문", "상담", "요청", "답변", "안내", "사항", "접수", "방법", "결과",
            "처리", "응대", "전화", "게시판", "등록", "조회", "취소", "분류"
        ));

        put("포인트", Arrays.asList(
            "마일리지", "리워드", "적립", "사용", "전환", "소멸", "이체", "충전",
            "환급", "혜택", "정책", "제도", "카드", "결제", "선물", "양도", "합산"
        ));

        put("전화", Arrays.asList(
            "통화", "콜센터", "상담", "고객센터", "ARS", "연결", "접수", "응대",
            "예약", "대기", "안내", "주문", "상담사", "수신", "발신", "회신"
        ));

        put("모바일", Arrays.asList(
            "스마트폰", "앱", "어플", "뱅킹", "서비스", "결제", "카드", "조회",
            "이체", "신청", "등록", "로그인", "버전", "전용", "기기", "환경", "보안"
        ));

        put("기간", Arrays.asList(
            "기한", "날짜", "일자", "만기", "계약", "유효", "처리", "신청", "조회",
            "등록", "이용", "약정", "설정", "연장", "만료", "종료", "초과"
        ));

        put("조건", Arrays.asList(
            "요건", "기준", "자격", "제한", "변경", "검토", "충족", "미달",
            "설정", "적용", "수정", "추가", "삭제", "조회", "비교", "선택"
        ));

        put("조치", Arrays.asList(
            "처리", "해결", "대응", "처방", "사항", "내용", "결과", "방법", "완료",
            "요청", "계획", "절차", "단계", "시간", "담당", "보고", "현황"
        ));

        put("제출", Arrays.asList(
            "접수", "신청", "등록", "송부", "서류", "방법", "기한", "완료", "요청",
            "상태", "자료", "증빙", "기간", "양식", "절차", "보완", "반려"
        ));

        put("화면", Arrays.asList(
            "페이지", "메뉴", "창", "구성", "설정", "이동", "전환", "조회", "오류",
            "로딩", "갱신", "크기", "배치", "디자인", "구현", "표시", "팝업"
        ));

        put("입력", Arrays.asList(
            "기입", "작성", "등록", "타이핑", "사항", "내용", "방법", "양식", "오류",
            "완료", "취소", "수정", "필드", "창", "필수", "선택", "데이터"
        ));

        put("상태", Arrays.asList(
            "현황", "진행", "처리", "승인", "신청", "접수", "등록", "조회", "거래",
            "계약", "대출", "이체", "보안", "시스템", "운영", "정지", "해지"
        ));
    }};

    public static String recommendTagsForQuery(String query) {
        if (query == null || query.trim().isEmpty()) {
            return "";
        }

        // 질문 토큰화
        List<String> questionTokens = FAQTokenizer.tokenizeNewQuestion(query);

        // 각 태그별 점수 계산
        Map<String, Double> tagScores = calculateTagScores(questionTokens);

        // 상위 3개 태그 선택
        return tagScores.entrySet().stream()
                .sorted((e1, e2) -> Double.compare(e2.getValue(), e1.getValue()))
                .limit(3)
                .map(Map.Entry::getKey)
                .collect(Collectors.joining(","));
    }

    private static Map<String, Double> calculateTagScores(List<String> tokens) {
        Map<String, Double> scores = new HashMap<>();

        // 각 태그에 대한 점수 계산
        for (String tag : PREDEFINED_TAGS) {
            double score = calculateTagScore(tokens, tag);
            scores.put(tag, score);
        }

        return scores;
    }

    private static double calculateTagScore(List<String> tokens, String tag) {
        // 기본 점수 계산 (직접 일치)
        double directMatchScore = tokens.stream()
                .filter(token -> token.equals(tag))
                .count() * 2.0;  // 직접 일치는 가중치 2배

        // 관련 키워드 매칭 점수
        double keywordMatchScore = 0.0;
        List<String> relatedKeywords = TAG_KEYWORDS.getOrDefault(tag, Collections.emptyList());

        for (String token : tokens) {
            if (relatedKeywords.contains(token)) {
                keywordMatchScore += 1.0;
            }
        }

        return directMatchScore + keywordMatchScore;
    }
}